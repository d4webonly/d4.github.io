// VyyyyyVyyyyyyyyyyyyyZyZZZZZZuuuuuuzzzw1=z1zzOvwswXyOXzlllli-_C.++--_:::~~___?7+._.......(r_O?????V+ow+>>;~_~.....~......_
// yVVyVyyyyyyyyyyyyyZyZZZZZZZuZuuuuXT=<~_<<<<<<?CwzXOUywOlllllzzldXOll=lzz--(11+--(7i......j_O?=???$x1?z>>j>..~.....~.___(<
// yyVyyVyVyVVVVyyyyyyZyyZZZZZuuuZ7<~~~~~_(_~~~.~(>~1zlvkwzlltltllll?Xzlllllll=lll=li-_?<-...bv?1??1X!`I?+v__(?>>_~__((<>>>>
// yyyyyyyyyyyyyyyyyyyZyZZZZZZZV>~~~~~~((<<~..~~_(l((++=zHwOtltttttlllZkzllllllllllll=z1-_<,.,k?1z?10``(OC~(>><<(+;+?>>>>+&&
// yyyyyyyyyyyyyyyyyyyZyyZyy0C<~~~~~~(<~~~~-((++zwklltlttlHXttltttttllllZyllllllllllllll=z+-<,(k?lz?X``(^(?<<(+1??>>>jwzI7"7
// yyyyyyyyyyyyyyyyyyyyZyZX3<~~~~~~~(~_((+ttttttttktttOttttSwttttttttlllllXOlllll==llll=ll=lz-?(h1z?d_J~+1&v1???1uv"! ``````
// yyZyyZyyyyyyyyyyyyyyZX6<~~~~~~~~(~(+OrttrttttttztttOtlltwXrttrrrrtttlttlOO11z=lllllllll==l==i?Nzldf(uX6???1c7!`````` ..vw
// yyyyyyyyyyyyyyyyyyyyfv::~:~~~~~(1zrrrrrrrrrrtttwrttOtttttSrrttrtrrttzttttto_((1=llltlllll=ll=li4zK(XC??1z4%```...-<<<uO+v
// ZyZyyyZyyyyyyVyyyyW$<~~~:___(((SOrrrrrrrrrtrrttrXtrtttttlWZrtOOtttrtO=ltttOS(zllllllOOlll==l=l==JQNgxuV1>1z1<+(+11?>>>>>>
// ZyyyZyyyyyVVVyVyyXC<::(++wvvvvKrvrrrvrrrrrrrrrrrXrwttttttXZrIz??zv1?tOzttttvszOllllllOOlll=lll===14ffHHppWAx<??>>>>>>>>>>
// yZyyyyyyyyyVyVyVK<:(<+wzvvvrvdSvzzvvvvrrrrrrrrrtwwwtrttttkrrOwz????1rrOtttttdyOZllllllOOl=llllll==1dHHHWWbbbHbpm&+>>>>>>>
// yZyZyyyyyVVyVVVf::;jwzzzzzzzvXvzzzzzvvvrrrrrrrrrrWwttrttdKrvvrI=lzzttttttrtttWOZwllllllwzllllllllll1?HqqqqqqqqkkbNHHmmyz&
// ZyZyZyyyVVVVyVf::+zzuuuzwwzzwRzzzzzzzvzvvvvrrrvrrdkrrrrtdVwzrrrttttrrtrtrttrtdklOhlllllOOlllllllll==l?HqqmqqqqkkkkkkpbMe.
// yZyyyyyyyVVyWK:<uuuuuuuzvuzwwXzzzzzuzzrvvrvOOrrrrrHtrtrd@wzrrrrttrrrtrrrtttwtlNtllWOrttOXllllllllll===?Wbbbqqqqqkqqqbpppp
// yyZyyyyVVVVVK<jwuuuuuuuvuuZtduzuuuzzzZOvzzvZzwrvrrdOrtOKrvvrrrrrrrrrrrrtrrtdtldllllWtOttztlllllllll=l==JHHbWkkqqqqkqkpppp
// yyyyyyyVVyfV<juZZuuuuuuuuzrOwuuuuuZuuZlOwXvZI=OOvrZKtOXrrrrrrrrrrrrwrrtrtrrZlldRllltHwwtvtllllltllll=l==?NmyWkkkqqqkkbbpp
// yyyyyyVVVV0<jZZZuuuuuuuuzvwXXuuuuzruutllllO=l=llzOOHQSvvrvrrrrrttrwvrtrrrrdI==dRllllONwOrttttltllllll=l==zHHkuUHHHHkkkbbb
// yyZyyyVyV0;+ZZZZZuuuuuuuvwXUuuuuuzzuwtllztttllllzvQH0zvvvvvvrrrOwyXrrrrrwdWSlldKllllldRzrlltlltlllll=====lOWqHHQkXWHHqHkb
// yZyyyyVVW>;dZZuZZuZuuZuzzuuwkvzuzzwuuwvrzzzzwwAQW8vvvvvvvvvvwQHWZXkrrrrZSOlKttdSltttlldkOtltllltlltl======v2WkkkHKWkVyVWH
// yyyyyyVV3:+ZZZZZZuZuuXXXuzzdKzzuuvvXuuuuuuuuzzzuUUWMWQmQWWHyZXUVAKvvQVtwwrtRttdlltlttttHkllttltttllz======?dzWqkbH,._?4yZ
// yyyyyyyf:;jZZZZZZZZZZWXzzzQE#zzuuzvvuuuuuuuuuuuuzzuuuNzvzvvvrrwd8dHHRttrXOtHtO#ttttttttZRllttlttllll=======zNvNbkkkqm,`?4
// yyVVVVW<;;dZZZZZZZZZXWXuuzHzHzuXuuzvzuZZZuuuuuuuuuuzzdKzzzvvwX8V8rrrXOrrrrrKtdSrtttttrttwlttlttlttlz======?=dMJNbkkkkbh``
// VVyVVWD;;>dZyZyyZZZZWSzuudE?dXuWkuuzzuuuuuuuuuuuuuuuuzXXzzzzzzvvvwwrrSrtttwRA@rrrttrrrrrwZtttlttltO====?===?dHNdNkyWWWWHX
// VVVffK;;;>XZyyZZyyZZHuXXuWI?JKzXHkuZuuZZuuuuZuuuuuuuuuuWXuzuzzzzzzwUWVkAwrdwKrrrrrrrttrrrZlllOllll======?==?zMWZMHNQWyyyy
// ffpfW3;:<>XZZyZZZyyyHXXuX@1>>WzXXZRuuuuWZuuuuXkuuuuuuuuuWXuzuzzuzzzzzvvvXVXHkAywrrrrtrrrtSzllll=l==z==?=?==?=NHHJqqb-HyyZ
// ppppD;;:+?ZyyZyyZZZyWSuud6?>>JKuSXWWkuuXyZuwX8uuZZZZZuuuuWXuuuzuzzzzzwQK9U0rrrrXVUUUXwAwrwwl==ll==zww========dRMkHkH?(4kZ
// pppK;;;+wzXZyZyZyZZZWuuuW1??>>dkXkHuXkkuuWWUuzzzzuuXuuZuuXXwzuzzzzzzzzvvvrwrttttrrrrrrrrrXUUVOzzzlzrwO=ll=l=l=dHUNbHm-1_T
// bpbC;<<duIdZZyZZyZZZuuuX#?????1NXWkuuNWQkZWkuzuzzzzvvzvzzvvXyvzzzzzvrrrrtttwwtttlllltOrrrrrzOlll=lltrwI1lllll=llvUHWbN+<<
// bWf;;+juukdZZZZZZZZuZuuXD>?>???zNXMkuXM17HkXHXuzuzzzzzzzvvvvZXvvvvzzrrrtttttZWyttttlltlllttwwllllllzrOOO(zzllllll1+(vT9XH
// W5;;;IduuuzZyZZZZZZZZuudC>?>>>>?zHXdNZXh?1OVWXkuzuuzzzzzzvvvvvWmrvvvzrrrrrrrrrWHAOOrOOttttltrttllltlOOlltOvvZOOlll===ud0O
// 5>>++IwuuuXZZZZZZZZZXZudz?>????1uVWUxWkWNx?zOrZWkuuuuuuuuzzzzXXwHmyvwvvvrrrrrrrdWWWgAOOrrrvrrHytttlOOXtllttOtllllukWHW3==
// ;jdMW$wuuuuZZyyyZZZZXKuW+?>>?uZC?1=dWsvSyXUWWXmAApXuuuuuZXXuzuXVVWkWWyzzvvrrrrrrrrwWez7TY9UXwwdmyttWkOXOttltOllud5dHfWez=
// jMkpWPwuZZuZZZZyyyZyZHuH>?uvC?>???zlvWhz1TWkuuuuXXXHHkkuuuXWyWXXXXWHHmz7YUXmmAQgmAyrrVWa&x>>>>>H9XydkHOXsOttZWRIldXHpppHz
// HkkkHPwZuuuuZZZZZyyZZURHZ6?>>??>????==7Hmx>>79WkXXUUUUXWWkkuuuuuuUUUWWyW91><????1zvTYYYY>:;;<>>;>>dKHWHOZMBWmgQdH9SWHbbbH
// gmmmqbzuuZuZZyyZyZyyZXHWv????>?>?>????==?WHax+?1zTYY99UU6=zvTYYYYYY9C?>>>>;;;;;;<<<<<;;;::::;>;<;;+NdNOWytWe=zOOllwwdHkkH
// mmmqqN?uZuuuuXVZZyyyZuZMR?????>?>?>??????1zTBmX#1???11111?>+??====??>>>>>;;>;;;;;;;;;;;;;;;:;:::::+UbUNtOSOZWx==zOtZ6vNkk
// qqqqqMczuuZZZuXWZuZZZ@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ttwtdhz===ztldkk
// mqmmmHb+XuuZuZuXHXZZZ@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@V&zttOrdAz===lvNk
// mmmqmmM2zZZuZuZuZHkuZ@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@wrUOOwOOVx<<<+1T
// mmmmmmmNzXZZZZuZZZXNk@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ywwwwrrrrvVUUUWW
// qqkqkqqHNxXZuZuuuuuUH@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ZkrdmZ0wwrtrrrrr
// WHqqqmmqHNsOZuZZZZuZX@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@VyWOXXkz?zOU9XQg
// HHMMMMmmmm#SzuZuZZZuu@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@rZWdyTmZXx=?=lll
// qqqkqkqqmM6J3zZZZZyVW@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@trrdmXdNtZWez==l
// kqkkkqkHM5A&uwuZyWkuWyZWWHWHyrwHqWU0d1??????>?>?>>?>>?>??>?>?????>??>?>>>?>>?>>?>>>>>>>>>>;>;;>gd#0zuSrrSrttrtWmwWAOrXWez
// HkkkMMHQQkuuuZXQkMWHmkZZZyyZWHezOTTz1??????????>??>??>??>?>>?>?>>>?>>?>>>>?>>?>>>>>>>>>>>>>;>;d6dSrvWwXrrXOrrttrWWywW9XAX
// pppbbbbbkHHMMHm#XudfyXHHHWWkXyXW#z???????????>??>??>??>??>??>?>??>>?>>??>?>>?>>>>>>>>>>>>>>;>j9tKkrrZWwWsrwwrttrtrZHmWHH9
// ffppppppbkkkkkMXXuXbXyyWkUXklZUZ?????>??????>??>?>?>?>?>??>?>?>>?1u&&&+>?>??>>?>>>>>>>>>>>;;JStdHkrrrWWXdNyXkOttrtrrrZBmW
// VfffppppppbbbWUwXZZNzZWWZWWyZkz4c???>??????>???>??>??>?>?>1gU9UUvvrrvrd2>>>>>>>>>>>>>>>>>>jdIOOduSvrvXWWkwdHdywrrtrrrrvvv
// llltruyyVVfpp$(uyuudyuZWyXXUAwZWde????????????>?????>?>?>?dXvrvvvvvvvvvXx>>?>?>>?>>>>>>>>j5zIllXuyuzzddHVVkzdWWWwrtrrvrzz
// llllwuyyVVVp$~duSuuZNXuZZZZZZWHmAdHxugWH??>>????>?>>??>?>?dvzzzzzzzvvvvvb?>>?>>?>>>>>>>jdI==zl=KuXXzuXbdRuUuzzvUWkwrrvvvv
// l===Ouyyyyff:(HuSuuuddZZZWyZZZZZZZZZZWHI??>???>>?>??>>?>??zkzzzzzzzzzzvzd2>>?>>>>>>>>jJ6===?=IzHzuuuuuHOdmzuuuzvzXWkwvvvv
// AAAAwXyVVWf:_(SZZuuuXNyZZXHyZZZZZZXW0XkI???>>?????????>????SuuuuzzzzzzzzzS>>>?>>>>>+J5tz==?=?zz#uuXuuzdkldmzzuzzzuzzXUWmw
// pfpfffffWf+wIduXuuuuXWWWZZZWkkXXQHSrtttUsz???>??>?>???>??>?duuuuzzzzuuzuzwI?>>>?>+g5v0l===1z==z#uuuuuzzNlldRzzzzzuuuzzzuX
// bbbkkkkH8jXuX#uZuuuuuXNpVXZZXNytrtttttltZHmzz????>?>???>?>?+UuuuuwOTTTTXVY??>>?+gMQaylOl==lvTHS#uXXXuuzdfttZNzuzzzuuuuzuu
// bbbbbbk8zzzzdSuZzzuuuWXWfVyZZZWmOrtrtlltlXSv9Qx??>??>>??>?>??vTT1>??>??>>?>??+dBNXyyWHMQgx====ZNXyyVXzuuNslltWyzzzuXyyXXk
// ppppbK3szzzzWuuuzuuuuWwHfyZyyZZZHmtrtttttOXz===79A&&+?>>?>?>>>>?>?>??>?>?>?1g8tdNHkkVyyVfWMMMMMMuZVyWuuzXMNylldXzzzzuXWyV
// ppppf1wuzzzw#uZuzzuuuXwdHyZZZVyZuXMmrrtltlwSl==?X$??+OHmgx???>>>?>>?>?>??ud9rtrrMgmHWVVyyyWfWbMMKXyyVXuuuXNXSAsH8uuzzuuuz
// fffY(zzuzzzdSuuuzzzuuX0tdkZZZZVWXZZZHmOtttOX===?X1?ugMgmHNZVUUwzz++??>1dUrrrrrrrMHXHgkyVVyyZZWyWNuXyXWuuuuVNW8wzuXuuuuzuX
// VW6jzzzzzzzWuuuuzzuuuXXtrNZZZZZZWWkkZZWNstlXllljfudMHHWkXXNttOOOOrrZU90rrrrrrrrrdHggggHyyyyyZZZuVNXzuXWXuuuuWyrrrvWuuuzXX
// Y>Juuzzzzvw#uuuzzzuzuXkOtd#WZZZZZZXHMkXZZHstttldMHWVVWM@@@MN??????zzOrrrrrrrrttrZMMHgHmHkWyyyyyZZXNkzuuWVyZyyXXHWkXkuuXSu
// iduzzzvzzzdSuuuuuzzuuXkwtrHyfWZZZZXXXXXWHXZHmudNWVVWZWMggg@MR??>?>???1zzOrtrrrtttZZZTHMWHkXZZZyZZuZWMHmQQkWXuuuZZyZ#uXSuu
// duzzzzzzXg#uuZZuuzuuuXWZttdKyWpWXZZyVfVVfWZZXMNWVfWuuHmmgMM8ZI???>??>????>??1111<<1zz<?MpHHwXZZZZuZZWbbbbWWHMMMMMMMNuXuud
// ZuuzuXX9XdEuuZuuzuzuuXHZrttNZyfpppHWkyZZWWyXZZXMKWXuuUHmM8===O=???>??>?>??>>>?>>>>>>;>;JHffpywXXXUWXXZWpWuuuUWWHkWHMXXQMX
// ZuXkHdWUzKuuuyuuuzuuudWZtttdKZXfppHWHHMMHkkyVyZZUHwuzXM#1????zI=???>??>>>?>>?>>>>>>>>>;;dkzXWwdZUZuuuuZZXZuuuuuuXWHMuq#uX
// XWUzvvvvdHZuZSuuuuzuudQmkHMH#ZZWpppZdNZWMqMMNWWZZZWmuXHx??????z==???>??>??>?>>?>>>>>>>>;<NXzuuHwrwXuuuuZuZXWXuXXUQHuqEwXp
// kzzzzvvvXZZuZuuuuXkMHWZZyyZZNuZZWfWyWUNMkmqkHHNkZuZWNuWb??????zz??>>?>>?>>?>?>>>>>>>>>;;;?NZkXHykrwqMMNmkXuuuzzzQHZX#zXkU
// zvvvwQQHHZZZXuuQdHyyWWWyZZZZWZuZXWyyXWWNkHkHUzuMkZZZXNX#??????????>?>????>?>>?>>>>>>;>>;>>?NXWWZykuHppWMpMMHkkwQHuuXSQHSr
// QV9C+juXyZZZWQMNWHyyZZyyyyyZWZZuZZZZZWZdNkW0zuuuMkZyZyNHz??????????>?>?>??>?>?>>>>>>>>>>>>&dHWyyyVdNfffpNffWHyyHSuZHqMXzw
// kI<<<(XHZZZySdNHyWyyyyyyyVyWWyZuZZZZuZkZMSvzzwuuXWyZZZZM2???????>>??>?>?>?>>>>?>>>>>>>>jZC>>dkyZXWHVVyyVWHffHyW#ZuXHMUzXM
// XIz(c(WZyZZXZdNyZyyZuZZuXUXXdSZZuuZZZZWXXNwXzzuuHZZyZZyZN???>??>?>>?>?>>?>?>>????>>>+z1>>>>>>XWyWWSUUuvwXWkWV0WZZuXMSQHHM
// uOz(I(WZyZyZXMWNuuuUuuuuzzvvWZZZZuuuuZXHZdyXdUUdWZZZZZZZXN&z??>>?>?>>>??>?>?>>>??1z1>?>>>>>>>>4SWSQkyWWkrwW9Zw#XuudRdSwWd
// XOz(nHyZyZyXHWWWHuuzuuzzzvvdHZZZZZZZZuXHZZNUuXHWZZZZZZZZZM2?zzz=z??????????>?>??>?>>>>>>>>>>>>>zHyUWfpWXrrwXtdHWuuX#yvdN6
// Uwz(HyZZZyyWHSuuXHuzukzzzvw0XZZuZuXfWZdHXuMXkHZZZZZZZZZZZXb???????>????????>>??>>>>>>>>>>>>>>??>?HvwWbKHOllwwdHyZuuNfWdKt
// rrIjHZZyZyWNWyXzvXRvvwXzzw6jZZyZZZXpWZHNQkMSZZZZZZZyZZZZZu#>>>>>>?>?>>??>?>>>>>>>>>>>>>>>>>>>>>>>dkwXbW@rOllddWyVXuXNWM0t
// ttwHyyyZyXMWWUXzvwXRvvZkd5dZZZyZZZZZWkkXZZZZZZZZZZyZZZZZuZH??????>>??>>>>>>>?>>>>>>>>>>>>>>>>>>>>>WXXWXKwAsl=dHVyyXXMN#tt
// =1HyyZyyyMHkzvzzwWpWRvvdSZZZZZZZZZZZXWppfWXQQQQKZZZZZZZZZX8??????>?>??>>>>>>>>?>>>>>>>>>>>>>>>>>>>?NkXXHNppHkyNVyVVXuM8ll
// jMWyyZZWyM@NXzvvvXUWWkdwZZyZZXyZZZZZZZZyyWqMgHHZZXyyZZZZZK???????>>>>>?>>?>>>>>>>>>>>>>>>>>>>>>>>>>dkWXNXVVVWXdHXUZHMMOlt
// 9dyyyyXWyWNkbWkuzvvrvXZZZXWZZyyyZZZZZZZZZZyWHffffffyZZZQK?????????>?>?>?>>?>>?>>>>>>>>>>>>>;>;>>>;><NWdUWHXWSwwWHkzdM#tll
// dyyyZyWyySWHkkWWWwvvdSZuXWZuZyyyyZZZZyZZZZZZZZZZZZZZuuqD????????>?>?>>>>?>>>>>?>>>>>>>>>>;;>>;>;>;;;JRdXzXOwOrwXrwXZO#AOO
// yyyyyXWZW0dMHHVyyZZXHZZZyWZuZZyXWyyyZZyZZZZZZyZZZZZXqMWD??????>>>>?>>>>>>>>>>>>>>>>>>>>>>>>;>>>>+ivC<WXSuvvOOtOdktrwvNppk
// yyyyyyyyWzvMNqWWyWkMZZZyVWZZZuZZuZZQKWHHHQmmmmmkHHSXdNWD????????>>>>>>?>>>>>>>>>>>>>>>++C7<;;:wuSx;;;?#HzvrttttZWwzwXdHpb
// yyyyyyyyRvvdMNHpW8jSZuZyyWWuZZZZuuHMRruwvXUHWWHVrrrrwNWb??>?>>>>>?>>>>>>>>>>>>>?+++>>+;;;;;;;;I;;jy;;;dWzrtttOttXRuuzXNWp
// yyyyyyyWSrrZNHMHXuXZuZZyyZkZZuZZudH@HwrwzuuvrzWwrrrrrMWb?>?1z?>>>>>?>>>>>>>?+z<;;>Z<<<<;>;;;;<I;;j?z;;?#krtttttrvWXzvvXNf
// yyyyyZyWzvrvdHHZZZZZZZZZZZZZZuZZXNXwXkuuXX0rtdXvrrOrrMWDYC<>?y+&&&&+>>?++z<>>>>;;;I;;;1;>>+;;j;;;j;+z+VMXrtlllltOZkXvzuMK
// yyyyZyyKzvvwWMZZZZWZZuZuZZZZZZZZdNrrVwwdXXwttdkOrrrOrdHD>+z>>o;?>>>zYCC$>;;>>>+<>;I;;++2;z;;;z+++71>>+OdNvIlllllttXuXvXZM
// yyyyyyXSvvwkHyZZuXRZZZuZZuuZZZZydHvOwwZXvXrttdXvrrvwAwWD;j1??jx+?>+I>;>?z>>;>+>;;;C;+?+JzJvT1<;;>>>+&x7UNVOluQZVwwdXXuZZX
//
//
// いっぱい食べるきみが好き
//
//

/* ------------ Notice to YOU ------------- */
/*

本プログラム（シナリオや謎以外の意）の設計・開発はaki（Discord ID：akisan）が単独で行っています。

バグ　　：直接ご連絡下さい。次回作を作ることがあればそこにFBさせて頂きます。（本作への対応は恐らくありません）
要望　　：直接ご連絡下さい。次回作を作ることがあればそこにFBさせて頂く可能性がなきにしもあらず。
権利関係：直接ご連絡下さい。可能な限り早く確認・対応します。
ご感想　：ご感想は私ではなく、Xのポストやイベントチームへお願いします。

*/
/* --------------- Thanks ---------------- */

let gameState = {
  phase: "1",
  flags: [],
  aliceTyping: false,
  autoScroll: true,
  locked: false,
  badEndSystemShown: false,
  activeProblem: null, // 'A' | 'B' | 'C' | null
  problemLock: null, // 'A' | 'B' | 'C' | null
};

let keywords = [];
let typingElem = null;
const usedNonRepeatable = new Set();

/* ------------ utils ------------- */
// 正規化を強化したのでそのうちキーワードを整理するかもしれないししないかもしれない
function normalizeText(t) {
  return t
    .normalize("NFKC") // 全角半角互換正規化
    .toLowerCase()
    .replace(/\s/g, ""); // 空白除去
}

function entryId(k) {
  const ph = Array.isArray(k.phases) ? k.phases.join("|") : k.phases || "";
  const key = k.keyword || k.keywords || "";
  const req = (k.requiredFlags || []).slice().sort().join("&");
  const setf = (k.setFlags || []).slice().sort().join("&");
  const typ = k.type || "";
  return `${ph}::${key}::req{${req}}::set{${setf}}::${typ}`;
}
function isUsed(k) {
  return k.repeatable === false && usedNonRepeatable.has(entryId(k));
}
function markUsedIfNeeded(k) {
  if (k && k.repeatable === false) usedNonRepeatable.add(entryId(k));
}

/* 問題タグ推定（A/B/C を判定） */
function keywordProblemTag(k) {
  const all = [
    ...(k.requiredFlags || []),
    ...(k.setFlags || []),
    ...(k.clearFlags || []),
  ].join("|");
  if (/-A-/.test(all)) return "A";
  if (/-B-/.test(all)) return "B";
  if (/-C-/.test(all)) return "C";
  return null;
}

/* Status管理 */
function updateStatusBasedOnFlags() {
  const s = document.getElementById("alice-status");
  const name = document.getElementById("alice-name");
  const header = document.getElementById("chat-header");

  if (!s || !name || !header) return;

  const isBadEnd =
    gameState.flags.includes("phase3_badEnding") ||
    gameState.flags.includes("phase8_badEnding");

  if (isBadEnd) {
    s.textContent = "オフライン";
    s.classList.remove("online");
    s.classList.add("offline");
    header.classList.add("bad-end");
    name.classList.add("bad-end");
  } else {
    s.textContent = "オンライン";
    s.classList.remove("offline");
    s.classList.add("online");
    header.classList.remove("bad-end");
    name.classList.remove("bad-end");
  }
}

/* Flag 操作 */
function setFlag(f) {
  if (!gameState.flags.includes(f)) {
    gameState.flags.push(f);
    updateStatusBasedOnFlags();
  }
}
function clearFlag(f) {
  const i = gameState.flags.indexOf(f);
  if (i >= 0) {
    gameState.flags.splice(i, 1);
    updateStatusBasedOnFlags();
  }
}

/* ------------ load & boot ------------- */
fetch("data/keywords.json")
  .then((r) => r.json())
  .then((data) => {
    keywords = data;
    const p1 = keywords.find((k) => k.keyword === "__phase1_start");
    if (p1) sendAliceMessage(p1);
    console.log(
      "%cようこそ、幽廻即売会へ。%c\nデベロッパーツールを開くなんて、勇気がありますね。\nなんでこんな所を見ているんですか？\nアリスはあなたの助けを待っているようですよ。",
      "color: #b71c1c; font-size: 15px; font-weight: bold;",
      "color: #fff; font-size: 13px;"
    );
  });

/* ------------ DOM ------------- */
const chatLog = document.getElementById("chat-log");
const textInput = document.getElementById("textInput");
const sendButton = document.getElementById("sendButton");
const newMsgBtn = document.getElementById("new-message-btn");

let imageModal = null;
let imageModalImg = null;

function ensureImageModal() {
  if (imageModal) return;
  imageModal = document.createElement("div");
  imageModal.id = "img-modal-overlay";
  imageModal.innerHTML = `<button id="img-modal-close" aria-label="閉じる">×</button><img id="img-modal-img" alt="">`;
  document.body.appendChild(imageModal);
  imageModalImg = imageModal.querySelector("#img-modal-img");
  const closeBtn = imageModal.querySelector("#img-modal-close");
  closeBtn.addEventListener("click", closeImageModal);

  imageModal.addEventListener("click", (e) => {
    if (e.target === imageModal) closeImageModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && imageModal?.classList.contains("open")) {
      closeImageModal();
    }
  });
}
function openImageModal(src) {
  ensureImageModal();
  imageModalImg.src = src;
  imageModal.classList.add("open");
}
function closeImageModal() {
  if (!imageModal) return;
  imageModal.classList.remove("open");
  imageModalImg.src = "";
}

function addMessage(text, sender = "user", type = "text", specialClass = null) {
  const m = document.createElement("div");
  m.classList.add("message", sender);

  if (specialClass) {
    m.classList.add(specialClass);
  }

  if (sender === "user") {
    m.textContent = text;
  } else {
    if (sender === "system") m.classList.add("system");
    const html = String(text ?? "")
      .replace(/\n/g, "<br>")
      .replace(
        /(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      )
      .replace(
        /\[center\](.*?)\[\/center\]/g,
        '<span class="centered-text">$1</span>'
      );
    m.innerHTML = html;
  }
  chatLog.appendChild(m);
  if (gameState.autoScroll) scrollToBottom();
}
function addImage(src, sender = "alice") {
  const wrap = document.createElement("div");
  if (sender === "alice") {
    wrap.classList.add("message-image", sender);
  } else {
    wrap.classList.add("message", sender);
  }

  // system画像の場合は黒背景・中央寄せ
  if (sender === "system") {
    wrap.classList.add("system");
    wrap.style.background = "#000";
    wrap.style.alignSelf = "center";
  }

  const img = document.createElement("img");
  img.src = src;
  img.alt = "";
  img.style.borderRadius = "12px";
  img.style.display = "block";
  img.style.margin = "0 auto";
  img.addEventListener("click", () => openImageModal(src));

  wrap.appendChild(img);
  chatLog.appendChild(wrap);

  if (gameState.autoScroll) scrollToBottom();
}
function addSystemMessage(text) {
  addMessage(text, "system");
}
function scrollToBottom() {
  chatLog.scrollTop = chatLog.scrollHeight;
}

chatLog.addEventListener("scroll", () => {
  const nearBottom =
    chatLog.scrollHeight - (chatLog.scrollTop + chatLog.clientHeight) < 50;
  gameState.autoScroll = nearBottom;
  newMsgBtn.style.display = nearBottom ? "none" : "block";
});

/* ------------ matching ------------- */
function matchKeywords(userInput, kwObj) {
  if (!kwObj.keywords) return false;
  const list = kwObj.keywords.split(",").map((s) => normalizeText(s));
  const inp = normalizeText(userInput);
  return list.some((kw) => inp.includes(kw));
}
function requiredFlagsOK(k) {
  if (!k.requiredFlags || !k.requiredFlags.length) return true;
  return k.requiredFlags.every((f) => gameState.flags.includes(f));
}
function canTrigger(k, userInput) {
  const matched = k.keyword
    ? normalizeText(userInput) === normalizeText(k.keyword)
    : matchKeywords(userInput, k);
  return matched && requiredFlagsOK(k) && !isUsed(k);
}

/* ------------ Phase3 helpers ------------- */
function findPhase3Positive(userText) {
  const cand = keywords.filter(
    (k) =>
      k.phases?.includes("3") &&
      (k.setFlags || []).includes("phase3_done") &&
      matchKeywords(userText, k) &&
      requiredFlagsOK(k) &&
      !isUsed(k)
  );
  return cand[0] || null;
}
function findPhase3Negative(userText) {
  const cands = keywords.filter(
    (k) =>
      k.phases?.includes("3") &&
      matchKeywords(userText, k) &&
      ((k.setFlags || []).includes("phase3_badEnding") ||
        (k.setFlags || []).includes("phase3_badStack2") ||
        (k.setFlags || []).includes("phase3_badStack1")) &&
      requiredFlagsOK(k) &&
      !isUsed(k)
  );
  if (cands.length === 0) return null;
  cands.sort(
    (a, b) => (b.requiredFlags?.length || 0) - (a.requiredFlags?.length || 0)
  );
  return cands[0];
}

/* ------------ Phase4 helper ------------- */
function findPhase4Entry(userText) {
  // 雑談がフェーズ移行を荒ぶらせず、上手く動いてくれるようにお祈りする判定　(人∀・)ﾀﾉﾑ
  const isMainP4 = (k) => {
    const fs = [...(k.setFlags || []), ...(k.clearFlags || [])];
    const touchesPhaseFlag = fs.some((f) => /^phase/.test(f));
    const requiresP3Done = (k.requiredFlags || []).includes("phase3_done");
    return touchesPhaseFlag || requiresP3Done;
  };

  const cands = keywords.filter(
    (k) =>
      k.phases?.includes("4") &&
      matchKeywords(userText, k) &&
      requiredFlagsOK(k) &&
      !isUsed(k) &&
      isMainP4(k)
  );
  if (cands.length <= 1) return cands[0] || null;

  const has44 = cands.find((k) => (k.setFlags || []).includes("phase4-4_done"));
  const has45 = cands.find((k) => (k.setFlags || []).includes("phase4-5_done"));
  if (has44 && has45) return has44;
  cands.sort(
    (a, b) => (b.requiredFlags?.length || 0) - (a.requiredFlags?.length || 0)
  );
  return cands[0] || null;
}

/* ------------ Phase5 helpers（activeProblem + problemLock） ------------- */
function findPhase5Entry(userText) {
  let cands = keywords.filter(
    (k) =>
      k.phases?.includes("5") &&
      matchKeywords(userText, k) &&
      requiredFlagsOK(k) &&
      !isUsed(k)
  );
  if (cands.length === 0) return null;

  // flag管理がイケてないせいで導入した苦肉の策(;O;)
  if (gameState.problemLock) {
    const lockedTag = gameState.problemLock;
    const filtered = cands.filter((k) => {
      const tag = keywordProblemTag(k);
      return tag === lockedTag || tag === null;
    });
    if (filtered.length === 0) {
      const labelMap = { A: "あ２", B: "い５", C: "う４" };
      const shown = labelMap[lockedTag] || lockedTag;
      addSystemMessage(
        `現在、スペース${shown}ルートを進行中です。<br>他のスペースに移動したい場合は「分からない」等のメッセージをアリスにお伝えください。<br>まだスペース${shown}の謎を発見できていない場合は、発見した後に再度「分からない」とお伝えください。`
      );
      return null;
    }
    cands = filtered;
  }

  const scored = cands.map((k) => {
    const tag = keywordProblemTag(k);
    let score = 1;
    if (gameState.activeProblem) {
      if (tag === gameState.activeProblem) score = 3;
      else if (tag && tag !== gameState.activeProblem) score = 0;
    }
    return { k, score, reqLen: k.requiredFlags?.length || 0 };
  });
  scored.sort((a, b) => b.score - a.score || b.reqLen - a.reqLen);
  return scored[0].k;
}

/* ------------ SmallTalk helpers ------------- */
function findSmallTalkEntry(userText) {
  const p = String(gameState.phase).startsWith("3")
    ? "3"
    : String(gameState.phase).startsWith("4")
    ? "4"
    : String(gameState.phase).startsWith("5")
    ? "5"
    : String(gameState.phase).startsWith("6")
    ? "6"
    : null;
  if (!p) return null;

  const isMain = (k) => {
    const fs = [...(k.setFlags || []), ...(k.clearFlags || [])];
    return fs.some((f) => /^phase/.test(f)); // 本編進行フラグを触るものは除外
  };
  return (
    keywords.find(
      (k) =>
        k.phases?.includes(p) &&
        matchKeywords(userText, k) &&
        requiredFlagsOK(k) &&
        !isUsed(k) &&
        !isMain(k)
    ) || null
  );
}

/* ------------ activeProblem / problemLock ------------- */
function updateActiveProblemByFlagsJustSet(flagsJustSet) {
  if (!flagsJustSet || !flagsJustSet.length) return;

  // activeProblem 推定
  if (flagsJustSet.some((f) => /-A-/.test(f))) gameState.activeProblem = "A";
  if (flagsJustSet.some((f) => /-B-/.test(f))) gameState.activeProblem = "B";
  if (flagsJustSet.some((f) => /-C-/.test(f))) gameState.activeProblem = "C";

  // problemLock の設定（開始トリガ/着手トリガ）
  if (
    flagsJustSet.includes("phase5-A-1_done") ||
    flagsJustSet.includes("phase5-A-4_doing")
  )
    gameState.problemLock = "A";
  if (
    flagsJustSet.includes("phase5-B-1_done") ||
    flagsJustSet.includes("phase5-B-4_doing")
  )
    gameState.problemLock = "B";
  if (flagsJustSet.includes("phase5-C-1_doing")) gameState.problemLock = "C";

  // クリア/退避でロック解除
  if (flagsJustSet.includes("phase5-A-5_done") && gameState.problemLock === "A")
    gameState.problemLock = null;
  if (flagsJustSet.includes("phase5-B-5_done") && gameState.problemLock === "B")
    gameState.problemLock = null;
  if (flagsJustSet.includes("phase5-C-4_done") && gameState.problemLock === "C")
    gameState.problemLock = null;

  if (
    flagsJustSet.includes("phase5-A-4_doing_save") &&
    gameState.problemLock === "A"
  )
    gameState.problemLock = null;
  if (
    flagsJustSet.includes("phase5-B-4_doing_save") &&
    gameState.problemLock === "B"
  )
    gameState.problemLock = null;
  if (
    flagsJustSet.includes("phase5-C-1_doing_save") &&
    gameState.problemLock === "C"
  )
    gameState.problemLock = null;
}

/* ------------ 進捗（Phase5） ------------- */
function maybeSendPhase5ProgressIfNeeded(lastSetFlags) {
  if (!lastSetFlags || !lastSetFlags.length) return;
  const solvedNow = [
    "phase5-A-5_done",
    "phase5-B-5_done",
    "phase5-C-4_done",
  ].some((f) => lastSetFlags.includes(f));
  if (!solvedNow) return;
  const has33 = gameState.flags.includes("phase5_33perDone");
  const has66 = gameState.flags.includes("phase5_66perDone");
  const has99 = gameState.flags.includes("phase5_99perDone");
  if (!has33 && !has66 && !has99) {
    const e = keywords.find(
      (k) => k.keyword === "__phase5_progress_33" && !isUsed(k)
    );
    if (e) {
      sendAliceMessage(e);
    }
    return;
  }
  if (has33 && !has66 && !has99) {
    const e = keywords.find(
      (k) => k.keyword === "__phase5_progress_66" && !isUsed(k)
    );
    if (e) {
      sendAliceMessage(e);
    }
    return;
  }
  if (has66 && !has99) {
    const e = keywords.find(
      (k) => k.keyword === "__phase5_progress_99" && !isUsed(k)
    );
    if (e) {
      sendAliceMessage(e);
    }
    return;
  }
}

/* ------------ Phase6 自動移行 ------------- */
function maybeEnterPhase6Auto() {
  if (
    gameState.flags.includes("phase5all_done") &&
    gameState.flags.includes("phase5_99perDone") &&
    !gameState.flags.includes("phase6_done")
  ) {
    const e = keywords.find((k) => k.keyword === "__phase6_auto" && !isUsed(k));
    if (e) {
      gameState.phase = "6";
      sendAliceMessage(e);
      return true;
    }
  }
  return false;
}

/* ------------ main reply ------------- */
function aliceReply(userText) {
  if (gameState.locked) return;

  // --- Nazonazo (riddle) special mode ---
  // nazonazoフラグ保持中は通常のキーワード処理を停止
  if (gameState.flags.includes("nazonazo")) {
    const correct = userText === "推しの存在"; // 仕様：完全一致
    const kwObj = {
      response: [
        {
          text: correct
            ? "A：推しの存在　でした～正解です！すごいですね！"
            : "A：推しの存在　でした～残念！難しかったですか？",
          delay: 1500,
        },
      ],
      phases: [],
      requiredFlags: ["nazonazo"],
      repeatable: false,
      type: "text",
      setFlags: [],
      clearFlags: ["nazonazo"],
    };
    sendAliceMessage(kwObj);
    return;
  }

  // Phase2-2
  if (gameState.phase === "2-1") {
    const hit = keywords.find(
      (k) => k.phases?.includes("2-2") && canTrigger(k, userText)
    );
    if (hit) {
      gameState.phase = "2-2";
      setFlag("phase2-2_done");
      sendAliceMessage(hit);
      return;
    }
  }

  // Phase2-3
  if (gameState.phase === "2-2" && gameState.flags.includes("phase2-2_done")) {
    gameState.phase = "2-3";
    const t = keywords.find(
      (k) => k.keyword === "__phase2_3_trigger" && !isUsed(k)
    );
    if (t) {
      sendAliceMessage(t);
      return;
    }
  }

  // Phase1
  if (gameState.phase === "1" && gameState.flags.includes("phase1_done")) {
    gameState.phase = "2-1";
    const t = keywords.find(
      (k) => k.keyword === "__phase2_1_trigger" && !isUsed(k)
    );
    if (t) {
      sendAliceMessage(t);
      return;
    }
  }

  // Phase3 正規/バッド
  const pos = findPhase3Positive(userText);
  if (pos) {
    gameState.phase = "3";
    sendAliceMessage(pos);
    return;
  }
  const neg = findPhase3Negative(userText);
  if (neg) {
    if (neg.setFlags?.includes("phase3_badStack1"))
      gameState.phase = "3-badStack1";
    else if (neg.setFlags?.includes("phase3_badStack2"))
      gameState.phase = "3-badStack2";
    else if (neg.setFlags?.includes("phase3_badEnding")) gameState.phase = "3";
    sendAliceMessage(neg);
    return;
  }

  // Phase4
  if (gameState.flags.includes("phase3_done")) {
    const p4 = findPhase4Entry(userText);
    if (p4) {
      gameState.phase = "4";
      sendAliceMessage(p4);
      return;
    }
  }

  // Phase5
  if (
    gameState.flags.includes("phase4-6_done") ||
    gameState.flags.includes("phase5_99perDone") ||
    gameState.phase === "5"
  ) {
    const p5 = findPhase5Entry(userText);
    if (p5) {
      gameState.phase = "5";
      sendAliceMessage(p5);
      return;
    }
  }

  // Phase7
  if (gameState.flags.includes("phase6_done")) {
    const p7 = keywords.find(
      (k) => k.phases?.includes("7") && canTrigger(k, userText)
    );
    if (p7) {
      gameState.phase = "7";
      sendAliceMessage(p7);
      return;
    }
  }

  // Phase8（正規/バッド）
  if (gameState.flags.includes("phase7_done")) {
    const p8 = keywords.find(
      (k) =>
        (k.phases?.includes("8-1") || k.phases?.includes("8-2")) &&
        canTrigger(k, userText)
    );
    if (p8) {
      gameState.phase = kHasPhase(p8, "8-2") ? "8-2" : "8-1";
      sendAliceMessage(p8);
      return;
    }
  }
  const chit = findSmallTalkEntry(userText);
  if (chit) {
    sendAliceMessage(chit);
    return;
  }
  setTimeout(() => {
    addSystemMessage("他のメッセージを送信してください。");
  }, 500);
}

function kHasPhase(k, p) {
  return (k.phases || []).includes(p);
}

/* ------------ Alice sender ------------- */
function sendAliceMessage(kwObj) {
  const isSystem = kwObj.type === "system";
  gameState.aliceTyping = true;
  sendButton.disabled = true;
  if (kwObj.lockInput) {
    gameState.locked = true;
  }

  let i = 0;
  const justSet = [];

  function showNext() {
    if (i >= kwObj.response.length) {
      if (typingElem) {
        typingElem.remove();
        typingElem = null;
      }

      if (kwObj.clearFlags) {
        kwObj.clearFlags.forEach(clearFlag);
      }
      if (kwObj.setFlags) {
        kwObj.setFlags.forEach((f) => {
          setFlag(f);
          justSet.push(f);
        });
      }
      if (kwObj.clearAllFlags) {
        const keep = justSet.slice();
        gameState.flags.slice().forEach(clearFlag);
        keep.forEach(setFlag);
      }

      markUsedIfNeeded(kwObj);

      // ロック/再ロック・解除の更新
      updateActiveProblemByFlagsJustSet(justSet);

      // 次フェーズ指定があれば反映
      if (kwObj.nextPhase) {
        gameState.phase = String(kwObj.nextPhase);
      }

      // バッドエンド（Phase3）
      if (
        gameState.flags.includes("phase3_badEnding") &&
        !gameState.badEndSystemShown &&
        kwObj.keyword !== "__phase3_badEnding_system"
      ) {
        const sys = keywords.find(
          (k) => k.keyword === "__phase3_badEnding_system" && !isUsed(k)
        );
        if (sys) {
          gameState.badEndSystemShown = true;
          sendAliceMessage(sys);
          return;
        }
      }

      // Phase6
      if (maybeEnterPhase6Auto()) return;

      // Phase8
      if (
        gameState.flags.includes("phase8-1_clear") &&
        kwObj.keyword !== "__phase8_1_system"
      ) {
        const sysG = keywords.find(
          (k) => k.keyword === "__phase8_1_system" && !isUsed(k)
        );
        if (sysG) {
          sendAliceMessage(sysG);
          return;
        }
      }
      if (
        gameState.flags.includes("phase8_badEnding") &&
        kwObj.keyword !== "__phase8_bad_system"
      ) {
        const sysB = keywords.find(
          (k) => k.keyword === "__phase8_bad_system" && !isUsed(k)
        );
        if (sysB) {
          sendAliceMessage(sysB);
          return;
        }
      }
      if (gameState.phase === "5") {
        maybeSendPhase5ProgressIfNeeded(justSet);
      }
      gameState.aliceTyping = false;
      if (!kwObj.lockInput) sendButton.disabled = false;
      return;
    }

    const msg = kwObj.response[i];

    if (!isSystem) {
      const startTypingDelay = 200;
      setTimeout(() => {
        if (typingElem) typingElem.remove();
        typingElem = document.createElement("div");
        typingElem.classList.add("message", "alice");
        typingElem.textContent = "入力中";
        chatLog.appendChild(typingElem);
        if (gameState.autoScroll) scrollToBottom();
      }, startTypingDelay);
      let dots = 0;
      const typingAnim = setInterval(() => {
        dots = (dots + 1) % 4;
        if (typingElem) typingElem.textContent = "入力中" + ".".repeat(dots);
      }, 500);

      const delay = msg.delay || 2000;
      setTimeout(() => {
        clearInterval(typingAnim);
        if (typingElem) typingElem.remove();
        if (msg.image) {
          addImage(msg.image);
        } else {
          const specialClass = msg.specialClass || kwObj.specialClass || null;
          addMessage(msg.text, "alice", kwObj.type, specialClass);
        }
        const nearBottom =
          chatLog.scrollHeight - (chatLog.scrollTop + chatLog.clientHeight) <
          50;
        if (nearBottom) {
          scrollToBottom();
          gameState.autoScroll = true;
        } else {
          newMsgBtn.style.display = "block";
        }

        i++;
        showNext();
      }, delay);
    } else {
      const delay = msg.delay || 1000;
      setTimeout(() => {
        if (msg.image) {
          addImage(msg.image, "system");
        } else {
          addMessage(msg.text, "system", "system");
        }
        const nearBottom =
          chatLog.scrollHeight - (chatLog.scrollTop + chatLog.clientHeight) <
          50;
        if (nearBottom) {
          scrollToBottom();
          gameState.autoScroll = true;
        } else {
          newMsgBtn.style.display = "block";
        }
        i++;
        showNext();
      }, delay);
    }
  }

  showNext();
}

/* ------------ UI events ------------- */
newMsgBtn.addEventListener("click", () => {
  scrollToBottom();
  newMsgBtn.style.display = "none";
  gameState.autoScroll = true;
});
sendButton.addEventListener("click", () => {
  if (gameState.aliceTyping || gameState.locked) return;
  const v = textInput.value.trim();
  if (!v) return;
  addMessage(v, "user");
  textInput.value = "";
  if (gameState.autoScroll) scrollToBottom();
  setTimeout(() => aliceReply(v), 100);
});
textInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendButton.click();
});
